#!/usr/bin/env sh

# Initially from:
# https://stackoverflow.com/questions/20479794/how-do-i-properly-git-stash-pop-in-pre-commit-hooks-to-get-a-clean-working-tree

# Stash all uncommited changes
old_stash=$(git rev-parse -q --verify refs/stash)
git stash -q --keep-index --include-untracked
new_stash=$(git rev-parse -q --verify refs/stash)

# If there nothing was stashed then we should skip everything.
if [ "$old_stash" = "$new_stash" ]; then
    echo "pre-commit script: no changes to test"
    sleep 1 # hack, editor may erase message
    exit 0
fi

# Format all nix files in my repo and add the changes
nix fmt -- ~/dots/**/*.nix && git add -A

# Restore changes
git reset --hard -q && git stash apply --index -q && git stash drop -q
